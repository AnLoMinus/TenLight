name: ğŸš€ Release & Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  release:
    name: ğŸ·ï¸ ×™×¦×™×¨×ª ×’×¨×¡×”
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi
        
    - name: ğŸ§ª Run tests
      run: |
        if [ -f package.json ]; then
          npm test
        fi
        
    - name: ğŸ—ï¸ Build project
      run: |
        if [ -f package.json ]; then
          npm run build
        fi
        
    - name: ğŸ“ Generate changelog
      run: |
        if command -v conventional-changelog &> /dev/null; then
          conventional-changelog -p angular -i CHANGELOG.md -s
        fi
        
    - name: ğŸ·ï¸ Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## ğŸ‰ ×’×¨×¡×” ×—×“×©×” ×©×œ TenLight
          
          ### ×©×™× ×•×™×™× ×¢×™×§×¨×™×™×:
          - ×¨××” CHANGELOG.md ×œ×¤×¨×˜×™× ××œ××™×
          
          ### ×”×•×¨×“×”:
          - ×§×•×“ ××§×•×¨: [Download Source](https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.zip)
          - ×× ×™×© ×—×‘×™×œ×•×ª: ×¨××” Assets ×œ××˜×”
          
          ### ×”×ª×§× ×”:
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd TenLight
          git checkout ${{ github.ref_name }}
          ```
          
          > "×•Ö°×”Ö¸×™Ö¸×” ×›Ö´Ö¼×™ ×™Ö´×§Ö°×¨Ö¸× ×Ö¶×ªÖ°×›Ö¶× ×Ö¹×©Ö¶××”, ×•Ö°× Ö´×’Ö·Ö¼×©× ×Ö²×œÖµ×™×›Ö¶× ×›Ö¸Ö¼×œ ×Ö²×©Ö¶××¨ × Ö°×“Ö¸×‘×•Ö¹ ×¨×•Ö¼×—×•Ö¹" â€” ×©××•×ª ×œ×´×”:×›×´×
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

  deploy-pages:
    name: ğŸŒ ×“×™×¤×œ×•×™ ×œ××ª×¨
    runs-on: ubuntu-latest
    needs: [release]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v5
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        fi
        
    - name: ğŸ—ï¸ Build for production
      run: |
        if [ -f package.json ]; then
          npm run build:prod
        else
          mkdir -p dist
          cp -r docs/ dist/ 2>/dev/null || echo "No docs directory"
          cp README.md dist/ 2>/dev/null || echo "No README"
        fi
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: tenlight.org
        user_name: 'TenLight Bot'
        user_email: 'bot@tenlight.org'

  notify:
    name: ğŸ“¢ ×”×•×“×¢×•×ª
    runs-on: ubuntu-latest
    needs: [release, deploy-pages]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify Discord
      if: env.DISCORD_WEBHOOK_URL != ''
      run: |
        curl -H "Content-Type: application/json" \
             -d '{
               "embeds": [{
                 "title": "ğŸ‰ TenLight Release",
                 "description": "×’×¨×¡×” ×—×“×©×” ×–××™× ×”: ${{ github.ref_name }}",
                 "color": 65280,
                 "fields": [
                   {
                     "name": "ğŸ”— ×§×™×©×•×¨×™×",
                     "value": "[GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})\n[Website](https://tenlight.org)"
                   }
                 ],
                 "footer": {
                   "text": "TenLight Project"
                 }
               }]
             }' \
             ${{ secrets.DISCORD_WEBHOOK_URL }}
             
    - name: ğŸ“¢ Notify Twitter
      if: env.TWITTER_API_KEY != ''
      run: |
        echo "ğŸ‰ TenLight v${{ github.ref_name }} ×©×•×—×¨×¨! ×—×§×•×¨ ××ª ×¢×©×¨×ª ×”×“×™×‘×¨×•×ª ×•×”×§×‘×œ×•×ª×™×”×Ÿ ×”×¨×•×—× ×™×•×ª. #TenLight #Torah #Kabbalah"
        # ×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ×©×œ×™×—×” ×œ×˜×•×•×™×˜×¨ ×× ×™×© API
